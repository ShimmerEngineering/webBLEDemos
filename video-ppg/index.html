<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shimmer3R PPG Demo (Video + Live HR)</title>

  <!-- Google tag (gtag.js) ‚Äî keep your measurement ID below -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T26GWN0LJW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-T26GWN0LJW');
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: #2196F3;
      --ok: #4CAF50;
      --warn: #FFC107;
      --danger: #f44336;
      --muted: #aaa;
      --card: #111;
      --border: #333;
      --maxw: 480px;
    }

    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { text-align: center; padding: 12px 16px; }
    header h1 { margin: 0 0 6px; font-size: 20px; font-weight: 700; }
    header p { margin: 0; color: var(--muted); font-size: 14px; }

    #controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px 12px; }

    button { padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; background: #222; color: var(--fg); transition: transform .02s ease, opacity .2s ease; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    button:active { transform: translateY(1px); }

    #scanBtn { background: var(--accent); }
    #connectBtn { background: var(--ok); }
    #streamBtn { background: var(--warn); color: #000; }
    #disconnectBtn { background: var(--danger); }

    #deviceName, #statusConsole, #hrDisclaimer { text-align: center; }
    #deviceName { margin: 6px auto 2px; font-weight: 600; }
    #statusConsole { color: #0f0; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; margin: 2px 0 10px; font-size: 14px; }

    iframe { display: block; margin: 16px auto 0; width: 100%; max-width: var(--maxw); aspect-ratio: 16 / 9; border: none; border-radius: 10px; overflow: hidden; box-shadow: 0 0 0 1px var(--border); background: #000; }

    #chartContainer { max-width: var(--maxw); margin: 18px auto; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }

    #hrDisclaimer { max-width: var(--maxw); margin: 8px auto 18px; color: #f39c12; font-size: 14px; }

    /* Intro Overlay */
    #introOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: var(--fg); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 16px; }
    .introContent { width: min(92vw, 520px); background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; text-align: left; box-shadow: 0 8px 30px rgba(0,0,0,.5); }
    .introContent h2 { margin: 0 0 8px; color: var(--danger); font-size: 20px; }
    .introContent p { margin: 8px 0; }
    .introContent ul { padding-left: 20px; margin: 8px 0; }
    .btnHint { background: #444; padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, monospace; }
    .introActions { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
    .introActions button { background: var(--ok); }
    #showTipBtn { background: #444; border-color: var(--border); }
  </style>
</head>
<body>
  <header>
    <h1>Shimmer3R GSR+/Proto3 PPG Demo</h1>
    <p>Scan ‚Üí Connect ‚Üí Stream PPG while watching a video. Live chart + demo BPM.</p>
  </header>

  <!-- Intro / Tips Overlay -->
  <div id="introOverlay" role="dialog" aria-modal="true" aria-labelledby="introTitle">
    <div class="introContent">
      <h2 id="introTitle">Welcome</h2>
      <p>This app visualizes a PPG waveform from a Shimmer3R GSR+/Proto3 and estimates heart rate (demo only).</p>
      <ul>
        <li><strong>Scan & connect:</strong> Tap <span class="btnHint">üîç Scan</span> then <span class="btnHint">üîó Connect</span>.</li>
        <li><strong>Start streaming:</strong> Tap <span class="btnHint">üì° Start Streaming</span> to view live data.</li>
        <li><strong>Watch:</strong> Enjoy the embedded video while monitoring your signal.</li>
        <li><strong>Live chart:</strong> See the PPG waveform update in real time.</li>
      </ul>
      <p><strong>Requirements</strong></p>
      <ul>
        <li><strong>Device:</strong> Shimmer3R GSR+</li>
        <li><strong>Firmware:</strong> Version ‚â• <code>v1.0.22</code></li>
      </ul>
      <img src="Shimmer3R_GSR.png" alt="Shimmer3R GSR+ device" style="width: 100%; max-width: 320px; display: block; margin: 10px auto;" />
      <ul>
        <li><strong>Device:</strong> Shimmer3R Proto3</li>
        <li><strong>Firmware:</strong> Version ‚â• <code>v1.0.22</code></li>
      </ul>
      <img src="Shimmer3_Proto3Deluxe.png" alt="Shimmer3R Proto3 device" style="width: 100%; max-width: 320px; display: block; margin: 10px auto;" />
      <div class="introActions">
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="dontShowAgain" /> Don't show this again
        </label>
        <button id="closeIntroBtn">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls" aria-label="Bluetooth Controls">
    <button id="scanBtn">üîç Scan Bluetooth</button>
    <button id="connectBtn" disabled>üîó Connect</button>
    <button id="streamBtn" disabled>üì° Start Streaming</button>
    <button id="disconnectBtn" disabled>‚ùå Disconnect</button>
    <button id="showTipBtn" title="Show tips overlay">üí° Show Tip</button>
  </div>

  <p id="deviceName">No device selected</p>
  <p id="statusConsole" aria-live="polite"></p>

  <!-- Embedded Video -->
  <iframe
    src="https://www.youtube.com/embed/CdOQEQ3GF6c"
    title="PPG / HR Video"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    allowfullscreen></iframe>

  <!-- Chart Container -->
  <div id="chartContainer">
    <canvas id="ppgChartCanvas" height="200" aria-label="PPG waveform"></canvas>
  </div>

  <p id="hrDisclaimer">
    ‚ö†Ô∏è <strong>Note:</strong> Heart rate estimation here is for demonstration only and has not been validated.
  </p>

  <script>
  'use strict';

  // =====================
  // Config & Constants
  // =====================
  const STORAGE_KEYS = { HIDE_OVERLAY: 'hidePPGIntroOverlay' };
  const BLE = {
    SERVICE_UUID: '65333333-a115-11e2-9e9a-0800200ca100',
    // Typical naming: RX (writes from client ‚Üí peripheral), TX (notifications peripheral ‚Üí client)
    CHAR_RX_UUID: '65333333-a115-11e2-9e9a-0800200ca102',
    CHAR_TX_UUID: '65333333-a115-11e2-9e9a-0800200ca101'
  };

  // Streaming command sequence (device-specific ‚Äî adjust if needed)
  const CMD = {
    SAMPLING: new Uint8Array([0x05, 0x00, 0x01]),     // configure sampling 128Hz
    CONFIG:   new Uint8Array([0x08, 0x00, 0x01, 0x00]),// sensor config
    EXP_PWR:  new Uint8Array([0x5E, 0x01]),            // experimental power
    START:    new Uint8Array([0x07])                   // start streaming
  };

  // =====================
  // State & Elements
  // =====================
  const el = {
    introOverlay: document.getElementById('introOverlay'),
    closeIntroBtn: document.getElementById('closeIntroBtn'),
    dontShowAgain: document.getElementById('dontShowAgain'),
    scanBtn: document.getElementById('scanBtn'),
    connectBtn: document.getElementById('connectBtn'),
    streamBtn: document.getElementById('streamBtn'),
    disconnectBtn: document.getElementById('disconnectBtn'),
    showTipBtn: document.getElementById('showTipBtn'),
    deviceName: document.getElementById('deviceName'),
    statusConsole: document.getElementById('statusConsole'),
    chartCanvas: document.getElementById('ppgChartCanvas')
  };

  const state = {
    device: null,
    server: null,
    rxChar: null, // write
    txChar: null, // notify
    receiveBuf: new Uint8Array(0),
    signalBuf: [],       // for smoothing
    peakTimestamps: [],  // for BPM (demo)
    chart: null,
    // Drawing throttle state
    drawQueue: [],
    rafPending: false,
	sampleX: 0        // <-- NEW: monotonic x for plotting
  };

  // =====================
  // Utilities
  // =====================
  const sleep = (ms) => new Promise(res => setTimeout(res, ms));

  function appendToBuffer(orig, chunk) {
    const out = new Uint8Array(orig.length + chunk.length);
    out.set(orig); out.set(chunk, orig.length);
    return out;
  }

  function setButtons({ scan, connect, stream, disconnect }) {
    el.scanBtn.disabled = !scan;
    el.connectBtn.disabled = !connect;
    el.streamBtn.disabled = !stream;
    el.disconnectBtn.disabled = !disconnect;
  }

  function setStatus(msg, type = 'info') {
    el.statusConsole.textContent = msg;
    console.log(msg);
  }

  // =====================
  // Intro Overlay Logic
  // =====================
  function maybeShowIntro() {
    const hide = localStorage.getItem(STORAGE_KEYS.HIDE_OVERLAY) === 'true';
    el.introOverlay.style.display = hide ? 'none' : 'flex';
  }

  function closeIntro() {
    if (el.dontShowAgain.checked) localStorage.setItem(STORAGE_KEYS.HIDE_OVERLAY, 'true');
    el.introOverlay.style.display = 'none';
  }

  // =====================
  // Chart Setup (optimized)
  // =====================
  function initChart() {
  const ctx = el.chartCanvas.getContext('2d');
  state.chart = new Chart(ctx, {
    type: 'line',
    data: {
      // With linear x, we don't need labels at all
      datasets: [{
        label: 'PPG Signal',
        data: [],                 // will be array of {x,y}
        borderColor: 'cyan',
        borderWidth: 2,
        tension: 0.1,
        pointRadius: 0,
      }]
    },
    options: {
      animation: false,
      parsing: false,           // we‚Äôre giving raw {x,y}
      normalized: true,
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'linear',       // <-- linear x so decimation works
          display: false
        },
        y: {
          title: { display: true, text: 'PPG' },
          beginAtZero: false,
          grid: { color: '#333' },
          ticks: { color: '#ddd' }
        }
      },
      plugins: {
        decimation: { enabled: true, algorithm: 'min-max' },
        legend: { labels: { color: '#fff' } }
      }
    }
  });
}

	// =====================
	// Throttled Drawing (~30 FPS)
	// =====================
	const FRAME_INTERVAL_MS = 1000 / 30; // target ‚âà 33.3ms per update
	let lastFrameTime = 0;

	function enqueueForDraw(ppgValue) {
	  state.drawQueue.push(ppgValue);
	  const now = performance.now();

	  // Only schedule a frame if none is pending and we‚Äôre past the 33 ms window
	  if (!state.rafPending && (now - lastFrameTime >= FRAME_INTERVAL_MS)) {
		state.rafPending = true;
		requestAnimationFrame(flushDraw);
	  }
	}

	function flushDraw(timestamp) {
	  state.rafPending = false;
	  lastFrameTime = timestamp || performance.now();
	  const { chart } = state;
	  if (!chart) return;

	  const MAX_POINTS = 512;
	  const ds = chart.data.datasets[0].data;

	  // Push all queued samples into the dataset as {x, y}
	  while (state.drawQueue.length) {
		const v = state.drawQueue.shift();
		ds.push({ x: state.sampleX++, y: v });
		if (ds.length > MAX_POINTS) ds.shift();
	  }

	  // Update without animation or layout thrash
	  chart.update('none');
	}


  // =====================
  // Heart Rate Estimation (demo only)
  // =====================
  function detectHeartRate(ppgValue) {
    const now = Date.now();

    // Simple moving average smoothing (N=10)
    const buf = state.signalBuf;
    buf.push(ppgValue);
    if (buf.length > 10) buf.shift();
    const smoothed = buf.reduce((a, b) => a + b, 0) / buf.length;

    // Naive peak detection: previous sample > previous-1 & above threshold
    const threshold = 30; // adjust per device gain
    if (
      buf.length >= 3 &&
      buf[buf.length - 2] > buf[buf.length - 3] &&
      buf[buf.length - 2] > smoothed + threshold
    ) {
      const lastPeak = state.peakTimestamps[state.peakTimestamps.length - 1] || 0;
      const dt = now - lastPeak;
      // Debounce: ignore peaks <300ms apart ( >200 bpm upper bound )
      if (dt > 300) {
        state.peakTimestamps.push(now);
        if (state.peakTimestamps.length > 10) state.peakTimestamps.shift();

        if (state.peakTimestamps.length >= 2) {
          const ts = state.peakTimestamps;
          const intervals = ts.slice(1).map((t, i) => t - ts[i]);
          const avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          const bpm = 60000 / avg;
          return Math.round(bpm);
        }
      }
    }
    return null;
  }

  // =====================
  // BLE Notification Parser
  // =====================
  function handleNotifications(evt) {
    const value = new Uint8Array(evt.target.value.buffer);
    state.receiveBuf = appendToBuffer(state.receiveBuf, value);

    // ACK handling: if the peripheral sends single 0xFF
    if (state.receiveBuf.length === 1 && state.receiveBuf[0] === 0xFF) {
      state.receiveBuf = new Uint8Array(0);
      return;
    }

    // Packetized format: 6 bytes per frame, leading 0x00, last 2 bytes = PPG (int16 LE)
    let offset = 0;
    const buf = state.receiveBuf;
    while (buf.length - offset >= 6) {
      if (buf[offset] === 0x00) {
        const packet = buf.slice(offset, offset + 6);
        const view = new DataView(packet.buffer, packet.byteOffset, packet.byteLength);
        const ppg = view.getInt16(4, true);

        // Queue for throttled draw instead of immediate chart.update()
        enqueueForDraw(ppg);

        const bpm = detectHeartRate(ppg);
        if (bpm) setStatus(`‚ù§Ô∏è BPM: ${bpm}`);

        offset += 6;
      } else {
        // Resync if out of alignment
        offset += 1;
      }
    }

    // Keep leftover partial bytes
    state.receiveBuf = buf.slice(offset);
  }

  // =====================
  // BLE Actions
  // =====================
  async function scan() {
    try {
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [BLE.SERVICE_UUID] }]
      });
      state.device = device;
      el.deviceName.textContent = `Selected: ${device.name || 'Unnamed Device'}`;
      setButtons({ scan: true, connect: true, stream: false, disconnect: false });
      setStatus('üîé Device selected. Click Connect.');
    } catch (err) {
      setStatus(`Scan cancelled or failed: ${err.message}`);
    }
  }

  async function connect() {
    if (!state.device) return alert('No device selected.');
    try {
      state.server = await state.device.gatt.connect();
      const service = await state.server.getPrimaryService(BLE.SERVICE_UUID);
      state.rxChar = await service.getCharacteristic(BLE.CHAR_RX_UUID);
      state.txChar = await service.getCharacteristic(BLE.CHAR_TX_UUID);

      await state.txChar.startNotifications();
      state.txChar.addEventListener('characteristicvaluechanged', handleNotifications);

      setButtons({ scan: true, connect: false, stream: true, disconnect: true });
      setStatus(`‚úÖ Connected to: ${state.device.name || 'Unnamed Device'}`);
    } catch (err) {
      setStatus(`Connection failed: ${err.message}`);
    }
  }

  async function startStreaming() {
    if (!state.rxChar) return alert('Not connected to device.');
    try {
      await state.rxChar.writeValue(CMD.SAMPLING);
      setStatus('Sent sampling command (0x05)');
      await sleep(200);

      await state.rxChar.writeValue(CMD.CONFIG);
      setStatus('Sent config command (0x08)');
      await sleep(200);

      await state.rxChar.writeValue(CMD.EXP_PWR);
      setStatus('Sent exp power command (0x5E)');
      await sleep(200);

      await state.rxChar.writeValue(CMD.START);
      setStatus('üì° Streaming started (0x07)');
    } catch (err) {
      setStatus(`Stream start failed: ${err.message}`);
    }
  }

  async function disconnect() {
    try {
      if (state.txChar && state.device?.gatt?.connected) {
        try {
          await state.txChar.stopNotifications();
          state.txChar.removeEventListener('characteristicvaluechanged', handleNotifications);
          setStatus('üîï Notifications stopped');
        } catch (notifyErr) {
          console.warn('Warn: stopNotifications:', notifyErr);
        }
      }
      if (state.device?.gatt?.connected) {
        state.device.gatt.disconnect();
        setStatus('üîå Disconnected');
      }
    } catch (err) {
      console.warn('Disconnect error:', err);
    }

    // Reset UI and state
    el.deviceName.textContent = 'No device selected';
    setButtons({ scan: true, connect: false, stream: false, disconnect: false });

    state.device = null;
    state.server = null;
    state.rxChar = null;
    state.txChar = null;
    state.receiveBuf = new Uint8Array(0);
    state.signalBuf = [];
    state.peakTimestamps = [];
    state.drawQueue = [];
    state.rafPending = false;
  }

  // =====================
  // Event Wiring
  // =====================
  function bindEvents() {
    el.scanBtn.addEventListener('click', scan);
    el.connectBtn.addEventListener('click', connect);
    el.streamBtn.addEventListener('click', startStreaming);
    el.disconnectBtn.addEventListener('click', disconnect);

    el.showTipBtn.addEventListener('click', () => {
      el.introOverlay.style.display = 'flex';
      localStorage.removeItem(STORAGE_KEYS.HIDE_OVERLAY);
    });
    el.closeIntroBtn.addEventListener('click', closeIntro);
  }

  // =====================
  // Init
  // =====================
  (function init() {
    setButtons({ scan: true, connect: false, stream: false, disconnect: false });
    maybeShowIntro();
    bindEvents();
    initChart();
  })();
  </script>
</body>
</html>