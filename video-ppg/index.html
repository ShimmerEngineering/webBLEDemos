<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shimmer3R PPG Demo (Video + Live HR)</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T26GWN0LJW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-T26GWN0LJW');
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: #2196F3;
      --ok: #4CAF50;
      --warn: #FFC107;
      --danger: #f44336;
      --muted: #aaa;
      --card: #111;
      --border: #333;
      --maxw: 480px;
    }

    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { text-align: center; padding: 12px 16px; }
    header h1 { margin: 0 0 6px; font-size: 20px; font-weight: 700; }
    header p { margin: 0; color: var(--muted); font-size: 14px; }

    #controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px 12px; }

    button { padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; background: #222; color: var(--fg); transition: transform .02s ease, opacity .2s ease; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    button:active { transform: translateY(1px); }

    #scanBtn { background: var(--accent); }
    #connectBtn { background: var(--ok); }
    #streamBtn { background: var(--warn); color: #000; }
    #disconnectBtn { background: var(--danger); }

    #deviceName, #statusConsole, #hrDisclaimer { text-align: center; }
    #deviceName { margin: 6px auto 2px; font-weight: 600; }
    #statusConsole { color: #0f0; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; margin: 2px 0 10px; font-size: 14px; }

    iframe { display: block; margin: 16px auto 0; width: 100%; max-width: var(--maxw); aspect-ratio: 16 / 9; border: none; border-radius: 10px; overflow: hidden; box-shadow: 0 0 0 1px var(--border); background: #000; }

    #chartContainer { max-width: var(--maxw); margin: 18px auto; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }

    #hrDisclaimer { max-width: var(--maxw); margin: 8px auto 18px; color: #f39c12; font-size: 14px; }

    /* Intro Overlay */
    #introOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: var(--fg); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 16px; }
    .introContent { width: min(92vw, 520px); background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; text-align: left; box-shadow: 0 8px 30px rgba(0,0,0,.5); }
    .introContent h2 { margin: 0 0 8px; color: var(--danger); font-size: 20px; }
    .introContent p { margin: 8px 0; }
    .introContent ul { padding-left: 20px; margin: 8px 0; }
    .btnHint { background: #444; padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, monospace; }
    .introActions { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
    .introActions button { background: var(--ok); }
    #showTipBtn { background: #444; border-color: var(--border); }

    /* Scroll-friendly overlay for small screens */
    #introOverlay { overflow-y: auto; -webkit-overflow-scrolling: touch; align-items: flex-start; padding-top: 10vh; }
    @media (min-height: 700px) { #introOverlay { align-items: center; padding-top: 0; } }
    .introContent { max-height: 90dvh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    body.noScroll { overflow: hidden; }
    #introOverlay, .introContent { overscroll-behavior: contain; }
  </style>
</head>
<body>
  <header>
    <h1>Shimmer3R GSR+/Proto3 PPG Demo</h1>
    <p>Scan ‚Üí Inquiry ‚Üí Stream PPG while watching a video. Live chart + demo BPM.</p>
  </header>

  <!-- Intro / Tips Overlay -->
  <div id="introOverlay" role="dialog" aria-modal="true" aria-labelledby="introTitle">
    <div class="introContent">
      <h2 id="introTitle">Welcome</h2>
      <p>This app visualizes a PPG waveform from a Shimmer3R GSR+/Proto3 and estimates heart rate (demo only).</p>
      <ul>
        <li><strong>Scan & Inquiry:</strong> Tap <span class="btnHint">üîç Scan</span> then <span class="btnHint">üîó Inquiry</span>.</li>
        <li><strong>Start streaming:</strong> Tap <span class="btnHint">üì° Start Streaming</span> to view live data.</li>
        <li><strong>Watch:</strong> Enjoy the embedded video while monitoring your signal.</li>
        <li><strong>Live chart:</strong> See the PPG waveform update in real time.</li>
      </ul>
      <p><strong>Requirements</strong></p>
      <ul>
        <li><strong>Device:</strong> Shimmer3R GSR+ / Proto3</li>
        <li><strong>Firmware:</strong> Version ‚â• <code>v1.0.22</code></li>
      </ul>
      <img src="Shimmer3R_GSR.png" alt="Shimmer3R GSR+ device" style="width: 100%; max-width: 320px; display: block; margin: 10px auto;" />
      <img src="Shimmer3_Proto3Deluxe.png" alt="Shimmer3R Proto3 device" style="width: 100%; max-width: 320px; display: block; margin: 10px auto;" />
      <div class="introActions">
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="dontShowAgain" /> Don't show this again
        </label>
        <button id="closeIntroBtn">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls" aria-label="Bluetooth Controls">
    <button id="scanBtn">üîç Scan Bluetooth</button>
    <button id="connectBtn" disabled>üîó Inquiry</button>
    <button id="streamBtn" disabled>üì° Start Streaming</button>
    <button id="disconnectBtn" disabled>‚ùå Disconnect</button>
    <button id="showTipBtn" title="Show tips overlay">üí° Show Tip</button>
  </div>

  <p id="deviceName">No device selected</p>
  <p id="statusConsole" aria-live="polite"></p>

  <!-- Embedded Video -->
  <iframe
    src="https://www.youtube.com/embed/CdOQEQ3GF6c"
    title="PPG / HR Video"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    allowfullscreen></iframe>

  <!-- Chart Container -->
  <div id="chartContainer">
    <canvas id="ppgChartCanvas" height="200" aria-label="PPG waveform"></canvas>
  </div>

  <p id="hrDisclaimer">
    ‚ö†Ô∏è <strong>Note:</strong> Heart rate estimation here is for demonstration only and has not been validated.
  </p>

  <!-- App logic using shimmer3r.js -->
  <script type="module">
  'use strict';
  import { Shimmer3RClient } from '../ShimmerAPI/shimmer3r.js';

  // =====================
  // State & Elements
  // =====================
  const el = {
    introOverlay: document.getElementById('introOverlay'),
    closeIntroBtn: document.getElementById('closeIntroBtn'),
    dontShowAgain: document.getElementById('dontShowAgain'),
    scanBtn: document.getElementById('scanBtn'),
    connectBtn: document.getElementById('connectBtn'),
    streamBtn: document.getElementById('streamBtn'),
    disconnectBtn: document.getElementById('disconnectBtn'),
    showTipBtn: document.getElementById('showTipBtn'),
    deviceName: document.getElementById('deviceName'),
    statusConsole: document.getElementById('statusConsole'),
    chartCanvas: document.getElementById('ppgChartCanvas')
  };

  const STORAGE_KEYS = { HIDE_OVERLAY: 'hidePPGIntroOverlay' };
  const state = {
    chart: null,
    signalBuf: [],
    peakTimestamps: [],
    drawQueue: [],
    rafPending: false,
    sampleX: 0
  };

  function setButtons({ scan, connect, stream, disconnect }) {
    el.scanBtn.disabled = !scan;
    el.connectBtn.disabled = !connect;
    el.streamBtn.disabled = !stream;
    el.disconnectBtn.disabled = !disconnect;
  }

  function setStatus(msg) {
    el.statusConsole.textContent = msg;
    console.log(msg);
  }

  // =====================
  // Intro Overlay
  // =====================
  function maybeShowIntro() {
    const hide = localStorage.getItem(STORAGE_KEYS.HIDE_OVERLAY) === 'true';
    el.introOverlay.style.display = hide ? 'none' : 'flex';
  }
  function closeIntro() {
    if (el.dontShowAgain.checked) localStorage.setItem(STORAGE_KEYS.HIDE_OVERLAY, 'true');
    el.introOverlay.style.display = 'none';
    document.body.classList.remove('noScroll');
    el.showTipBtn.focus();
  }

  // =====================
  // Chart Setup (linear x)
  // =====================
  function initChart() {
    const ctx = el.chartCanvas.getContext('2d');
    state.chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'PPG Signal',
          data: [],                 // {x,y}
          borderColor: 'cyan',
          borderWidth: 2,
          tension: 0.1,
          pointRadius: 0,
        }]
      },
      options: {
        animation: false,
        parsing: false,
        normalized: true,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { type: 'linear', display: false },
          y: {
            title: { display: true, text: 'PPG' },
            beginAtZero: false,
            grid: { color: '#333' },
            ticks: { color: '#ddd' }
          }
        },
        plugins: { decimation: { enabled: true, algorithm: 'min-max' }, legend: { labels: { color: '#fff' } } }
      }
    });
  }

  // Throttled drawing (‚âà30 FPS)
  const FRAME_INTERVAL_MS = 1000 / 30;
  let lastFrameTime = 0;
  function enqueueForDraw(ppgValue) {
    state.drawQueue.push(ppgValue);
    const now = performance.now();
    if (!state.rafPending && (now - lastFrameTime >= FRAME_INTERVAL_MS)) {
      state.rafPending = true;
      requestAnimationFrame(flushDraw);
    }
  }
  function flushDraw(ts) {
    state.rafPending = false;
    lastFrameTime = ts || performance.now();
    const chart = state.chart; if (!chart) return;

    const MAX_POINTS = 512;
    const ds = chart.data.datasets[0].data;
    while (state.drawQueue.length) {
      const v = state.drawQueue.shift();
      ds.push({ x: state.sampleX++, y: v });
      if (ds.length > MAX_POINTS) ds.shift();
    }
    chart.update('none');
  }

  // =====================
  // Demo HR estimator
  // =====================
  function detectHeartRate(ppgValue) {
    const now = Date.now();
    const buf = state.signalBuf;
    buf.push(ppgValue);
    if (buf.length > 10) buf.shift();
    const smoothed = buf.reduce((a, b) => a + b, 0) / buf.length;

    const threshold = 30; // tune per gain
    if (
      buf.length >= 3 &&
      buf[buf.length - 2] > buf[buf.length - 3] &&
      buf[buf.length - 2] > smoothed + threshold
    ) {
      const lastPeak = state.peakTimestamps[state.peakTimestamps.length - 1] || 0;
      const dt = now - lastPeak;
      if (dt > 300) {
        state.peakTimestamps.push(now);
        if (state.peakTimestamps.length > 10) state.peakTimestamps.shift();

        if (state.peakTimestamps.length >= 2) {
          const ts = state.peakTimestamps;
          const intervals = ts.slice(1).map((t, i) => t - ts[i]);
          const avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          return Math.round(60000 / avg);
        }
      }
    }
    return null;
  }

  // =====================
  // Shimmer3R library wiring
  // =====================
  const shim = new Shimmer3RClient();

  shim.onStatus = (msg) => setStatus(msg);

  shim.onInquiry = (info) => {
    // Show selected device & parsed schema
    el.deviceName.textContent = `Selected: ${shim.device?.name || 'Shimmer3R'}`;
    console.log('Inquiry info:', info);
    // Enable streaming once schema is known
    setButtons({ scan: true, connect: false, stream: true, disconnect: true });
    setStatus('‚úÖ Inquiry received. Schema ready.');
  };

  shim.onStreamFrame = (oc) => {
    const field = oc.get('PPG') || oc.fields.find(f => typeof f.value === 'number');
    if (!field) return;
    const ppg = field.value;
    enqueueForDraw(ppg);
    const bpm = detectHeartRate(ppg);
    if (bpm) setStatus(`‚ù§Ô∏è BPM: ${bpm}`);
  };

  // =====================
  // UI Actions
  // =====================
  function bindEvents() {
    // Scan: connect() via library (does browser device selection + GATT)
    el.scanBtn.addEventListener('click', async () => {
      try {
        await shim.connect();
        el.deviceName.textContent = `Selected: ${shim.device?.name || 'Shimmer3R'}`;
        setButtons({ scan: true, connect: true, stream: false, disconnect: true });
        setStatus('üîé Connected to device. Click Inquiry to fetch schema.');
      } catch (e) {
        setStatus(`Scan/connect failed: ${e.message}`);
      }
    });

    // Inquiry: send 0x01 and build schema from response
    el.connectBtn.addEventListener('click', async () => {
      try {
	    await shim.setInternalExpPower(1);
	    await shim.setSamplingRate(128);
        await shim.setSensors(256);
		await shim.inquiry();
      } catch (e) {
        setStatus(`Inquiry failed: ${e.message}`);
      }
    });

    // Start streaming: sends 0x07
    el.streamBtn.addEventListener('click', async () => {
      try {
        await shim.startStreaming();
        setStatus('üì° Streaming started (0x07)');
      } catch (e) {
        setStatus(`Start stream failed: ${e.message}`);
      }
    });

    // Disconnect
    el.disconnectBtn.addEventListener('click', async () => {
      try {
        await shim.disconnect();
      } catch {}
      el.deviceName.textContent = 'No device selected';
      setButtons({ scan: true, connect: false, stream: false, disconnect: false });
      // reset local state
      state.signalBuf = [];
      state.peakTimestamps = [];
      state.drawQueue = [];
      state.rafPending = false;
      setStatus('üîå Disconnected');
    });

    // Overlay open/close
    el.showTipBtn.addEventListener('click', () => {
      el.introOverlay.style.display = 'flex';
      localStorage.removeItem(STORAGE_KEYS.HIDE_OVERLAY);
      document.body.classList.add('noScroll');
      el.closeIntroBtn.focus();
    });
    el.closeIntroBtn.addEventListener('click', closeIntro);
  }

  // =====================
  // Init
  // =====================
  (function init() {
    setButtons({ scan: true, connect: false, stream: false, disconnect: false });
    maybeShowIntro();
    bindEvents();
    initChart();
  })();
  </script>
</body>
</html>
