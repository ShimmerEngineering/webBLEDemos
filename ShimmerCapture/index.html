<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shimmer3R Live Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { Shimmer3RClient, SensorBitmapShimmer3 } from '../ShimmerAPI/shimmer3r.js';

    const shimmer = new Shimmer3RClient({ debug: true });
    let isStreaming = false;
    let isSaving = false;
    let chart, chartData = {}, fileBuffer = [], headerRow = [];
    let sampleCounter = 0;
    const ctx = document.getElementById('chart').getContext('2d');

    const exgTestBtn = document.getElementById('exgTestBtn');
    const emg16Btn = document.getElementById('emg16Btn');
    const ecg16Btn = document.getElementById('ecg16Btn');

    // keep a small helper to enable/disable as a group
    function setEXGButtonsEnabled(enabled) {
        [exgTestBtn, emg16Btn, ecg16Btn].forEach(b => b.disabled = !enabled);
    }
    // disabled until connected
    setEXGButtonsEnabled(false);

    // Build Sensor Dropdown Menu
    const sensorMenu = document.getElementById('sensorMenu');
    for (const [key, value] of Object.entries(SensorBitmapShimmer3)) {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = key;
      sensorMenu.appendChild(option);
    }

    async function refreshEnabledSensors() {
      const enabled = shimmer.getEnabledSensors();
      for (const opt of sensorMenu.options) {
        const bit = parseInt(opt.value);
        opt.selected = (enabled & bit) !== 0;
      }
      document.getElementById('status').textContent = `Enabled sensors: 0x${enabled.toString(16).toUpperCase()}`;
    }

    exgTestBtn.onclick = async () => {
        if (!shimmer.device) return alert('Connect first.');
        try {
            setEXGButtonsEnabled(false);
            document.getElementById('status').textContent = 'Enabling EXG test signal (16‑bit)…';
            await shimmer.enableEXGTestSignal16Bit(); // will power expansion, program EXG pages, set sensors, and re-inquiry
            document.getElementById('status').textContent = 'EXG test signal enabled.';
        } catch (e) {
            console.error(e);
            alert('Failed to enable EXG test signal: ' + e.message);
        } finally {
            setEXGButtonsEnabled(true);
        }
    };

    emg16Btn.onclick = async () => {
        if (!shimmer.device) return alert('Connect first.');
        try {
            setEXGButtonsEnabled(false);
            document.getElementById('status').textContent = 'Enabling EMG (16‑bit) on EXG1 & EXG2…';
            await shimmer.enableEMG16Bit();          // programs EXG pages, sets EXG1/2 16‑bit sensors, triggers inquiry
            document.getElementById('status').textContent = 'EMG 16‑bit enabled.';
        } catch (e) {
            console.error(e);
            alert('Failed to enable EMG 16‑bit: ' + e.message);
        } finally {
            setEXGButtonsEnabled(true);
        }
    };

    ecg16Btn.onclick = async () => {
        if (!shimmer.device) return alert('Connect first.');
        try {
            setEXGButtonsEnabled(false);
            document.getElementById('status').textContent = 'Enabling ECG (16‑bit) on EXG1 & EXG2…';
            await shimmer.enableECG16Bit();           // powers expansion, programs EXG pages, sets sensors, triggers inquiry
            document.getElementById('status').textContent = 'ECG 16‑bit enabled.';
        } catch (e) {
            console.error(e);
            alert('Failed to enable ECG 16‑bit: ' + e.message);
        } finally {
            setEXGButtonsEnabled(true);
        }
    };

    // ---- Expansion power UI handling ----
    const expChk = document.getElementById('expPowerChk');
    expChk.disabled = true; // disabled until connected
    expChk.onchange = async (e) => {
      if (!shimmer || !shimmer.device) {
        expChk.checked = false;
        return alert('Connect to device first.');
      }

      const desired = expChk.checked ? 1 : 0;
      // disable while toggling to avoid double requests
      expChk.disabled = true;
      try {
        document.getElementById('status').textContent = `Setting expansion power to ${desired ? 'ON' : 'OFF'}…`;
        await shimmer.setInternalExpPower(desired);
        // setInternalExpPower updates shimmer.ExpPower and emits onExpPowerChanged
        expChk.checked = (shimmer.getInternalExpPower() === 1);
        document.getElementById('status').textContent = `Expansion power ${desired ? 'enabled' : 'disabled'}.`;
      } catch (err) {
        console.error('Failed to set expansion power', err);
        alert('Failed to set expansion power: ' + err.message);
        // revert visual state to cached value
        expChk.checked = (shimmer.getInternalExpPower() === 1);
        document.getElementById('status').textContent = 'Error setting expansion power.';
      } finally {
        expChk.disabled = false;
      }
    };

    // Keep checkbox in sync if client emits changes (e.g., enableEMG16Bit triggers setInternalExpPower)
    shimmer.onExpPowerChanged = (val) => {
      expChk.checked = (val === 1);
      expChk.disabled = false;
    };

    // -------- Buttons --------
    document.getElementById('applySensorsBtn').onclick = async () => {
      try {
        const selectedOptions = [...sensorMenu.selectedOptions];
        if (selectedOptions.length === 0) return alert('Select at least one sensor');
        let bitmask = 0;
        selectedOptions.forEach(opt => bitmask |= parseInt(opt.value));
        const result = await shimmer.setSensors(bitmask);
        await refreshEnabledSensors();
        document.getElementById('status').textContent = `Sensors applied (0x${bitmask.toString(16).toUpperCase()})`;
      } catch (e) { alert(e); }
    };

    document.getElementById('connectBtn').onclick = async () => {
      try {
        await shimmer.connect();
        document.getElementById('status').textContent = 'Connected. Running Inquiry...';
        const info = await shimmer.inquiry();
        await refreshEnabledSensors();

        // After connect, reflect cached expansion power state in the checkbox
        expChk.checked = (shimmer.getInternalExpPower() === 1);
        expChk.disabled = false;
        setEXGButtonsEnabled(true);
      } catch (e) { alert(e); }
    };

    document.getElementById('disconnectBtn').onclick = async () => {
      await shimmer.disconnect();
      document.getElementById('status').textContent = 'Disconnected.';
      // disable expansion power checkbox while disconnected
      expChk.checked = false;
      expChk.disabled = true;
      setEXGButtonsEnabled(false);
    };
	let signalListInitialized = false;
    document.getElementById('startBtn').onclick = async () => {
      if (!shimmer.device) return alert('Connect first.');
      isStreaming = true;
      fileBuffer = [];
      headerRow = [];
      sampleCounter = 0;
	  signalListInitialized = false;
      await shimmer.startStreaming();
      shimmer.onStreamFrame = onFrame;
      document.getElementById('status').textContent = 'Streaming…';
    };

    document.getElementById('stopBtn').onclick = async () => {
      isStreaming = false;
      try {
        await shimmer.stopStreaming();
        document.getElementById('status').textContent = 'Stream stopped.';
      } catch (e) {
        console.error('Error while stopping stream:', e);
        alert('Error stopping stream: ' + e.message);
      }
    };

    document.getElementById('saveBtn').onclick = () => {
      isSaving = !isSaving;
      const btn = document.getElementById('saveBtn');
      btn.textContent = isSaving ? 'Stop Saving' : 'Start Saving';

      if (!isSaving && fileBuffer.length > 0) {
        const csv = [headerRow.join(',')].concat(fileBuffer).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'shimmer_data.csv';
        a.click();
      }
    };

    // -------- Build signal list --------
    
// -------- Build signal list (name + kind) --------


function buildSignalList(fields) {
  const listDiv = document.getElementById('signalList');
  const signalNote = document.getElementById('signalNote');
  listDiv.innerHTML = '';

  // Collect unique (name, kind) pairs; ignore TIMESTAMP
  const pairs = [];
  const seen = new Set(); // key = `${name}||${kind??''}`

  for (const f of fields || []) {
    if (f.name === 'TIMESTAMP') continue;
    const kind = f.kind ?? null;
    const key = `${f.name}||${kind ?? ''}`;
    if (!seen.has(key)) {
      seen.add(key);
      pairs.push({ name: f.name, kind });
    }
  }

  // Create checkboxes labeled "NAME_KIND" (KIND uppercased; omit suffix if kind is null)
  pairs.forEach(({ name, kind }) => {
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';

    // Store both name and kind in the value
    cb.value = JSON.stringify({ name, kind });
    cb.onchange = rebuildChart;

    const suffix = kind ? `_${String(kind).toUpperCase()}` : '';
    label.append(cb, `${name}${suffix}`);
    listDiv.append(label, document.createElement('br'));
  });

}

// Stable hash from a string
function hashString(s) {
  let h = 2166136261; // FNV-1a seed
  for (let i = 0; i < s.length; i++) {
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0); // uint32
}

// Map hash -> pretty HSL color
function colorFromLabel(label, alpha = 1) {
  const h = hashString(label) % 360; // hue 0–359
  const s = 68;                      // saturation %
  const l = 52;                      // lightness %
  return {
    border: `hsl(${h} ${s}% ${l}%)`,
    fill: `hsla(${h} ${s}% ${l}% / ${alpha})`
  };
}


function rebuildChart() {
  const selected = [...document.querySelectorAll('#signalList input:checked')]
    .map(cb => JSON.parse(cb.value));

  chartData = {};

  const toLabel = ({name, kind}) =>
    kind ? `${name}_${String(kind).toUpperCase()}` : name;

  const datasets = selected.map(sel => {
    const label = toLabel(sel);
    chartData[label] = [];
    const { border, fill } = colorFromLabel(label, 0.15);
    return {
      label,
      _metaSel: sel,
      data: [],
      borderColor: border,
      backgroundColor: fill,
      borderWidth: 1,
      pointRadius: 0,
      fill: false
    };
  });

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      animation: false,
      parsing: false,
      scales: {
        x: { type: 'linear', title: { text: 'Sample Index', display: true } },
        y: { title: { text: 'Value', display: true } }
      }
    }
  });

  headerRow = ['SampleIndex', ...datasets.map(d => d.label)];
}


    
function onFrame(oc) {

  if (!signalListInitialized) {
    buildSignalList(oc.fields);  // now pairs include RAW/CAL
    signalListInitialized = true;
  }

  
if (!isStreaming || !chart) return;
  sampleCounter++;
  const row = [sampleCounter];

  for (const ds of chart.data.datasets) {
    const { name, kind } = ds._metaSel || {};
    const field = oc.get(name, kind ?? null);
    const val = field?.value ?? null;

    const label = ds.label; // "NAME_KIND"
    chartData[label].push({ x: sampleCounter, y: val });
    row.push(val);
  }

  if (isSaving) fileBuffer.push(row.join(','));

  for (const ds of chart.data.datasets) {
    const label = ds.label;
    const arr = chartData[label];
    if (arr.length > 200) arr.splice(0, arr.length - 200);
    ds.data = arr;
  }
  chart.update();

}



    shimmer.onStatus = (msg) => document.getElementById('log').textContent = msg;
  </script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    #toolbar { margin-bottom: 10px; }
    #chart { width: 100%; height: 400px; }
    button { margin-right: 6px; }
    #signalList { margin-top: 8px; }
    #log { font-size: 0.9em; color: #555; margin-top: 6px; }
    label.exp { margin-left: 12px; margin-right: 8px; }
  </style>
</head>
<body>
  <h2>Shimmer3R Web Bluetooth Viewer</h2>
  <div id="toolbar">
      <button id="connectBtn">Connect</button>
      <button id="startBtn">Start Stream</button>
      <button id="stopBtn">Stop</button>
      <button id="disconnectBtn">Disconnect</button>
      <button id="saveBtn">Start Saving</button>

      <select id="sensorMenu" multiple size="5" style="margin-left:10px; min-width: 220px;"></select>
      <button id="applySensorsBtn">Apply Sensors</button>

      <button id="exgTestBtn" disabled>EXG Test (16‑bit)</button>
      <button id="emg16Btn" disabled>Enable EMG 16‑bit</button>
      <button id="ecg16Btn" disabled>Enable ECG 16‑bit</button>

      <!-- Expansion power checkbox -->
      <label class="exp"><input id="expPowerChk" type="checkbox"> Expansion Power</label>
  </div>

  <div id="status"></div>
  <div id="signalList"></div>
  <small id="signalNote" style="color:#666"></small>
  <canvas id="chart"></canvas>
  <div id="log"></div>
</body>
</html>